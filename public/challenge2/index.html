<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Injection - ê²€ìƒ‰ ê¸°ëŠ¥ ìš°íšŒ</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .challenge-container { max-width: 600px; margin: 0 auto; }
        .challenge-box { background: #fff; border-radius: 18px; box-shadow: 0 4px 24px 0 rgba(84,9,218,0.10); padding: 36px 32px 32px 32px; margin-top: 32px; }
        .challenge-title { font-size: 1.3rem; font-weight: 800; color: #5409DA; margin-bottom: 18px; text-align: center; }
        .form-label { color: #4E71FF; font-weight: 600; margin-bottom: 6px; }
        .form-input { width: 100%; padding: 14px; border: 2px solid #8DD8FF; border-radius: 8px; font-size: 1rem; margin-bottom: 16px; background: #f8faff; color: #5409DA; transition: border 0.2s, box-shadow 0.2s; }
        .form-input:focus { border-color: #5409DA; outline: none; box-shadow: 0 0 0 2px #8DD8FF; }
        .action-btn { background: #5409DA; color: #fff; border: none; border-radius: 8px; padding: 14px 0; font-size: 1.1rem; font-weight: 700; width: 100%; cursor: pointer; transition: background 0.2s, transform 0.2s; margin-top: 8px; }
        .action-btn:hover { background: #4E71FF; transform: translateY(-2px) scale(1.03); }
        .result-area { margin-top: 20px; background: #f3f7ff; border-radius: 8px; padding: 18px 16px; color: #5409DA; box-shadow: 0 2px 8px 0 #8DD8FF22; display: none; }
        .flag-container { background: #5409DA; color: #fff; border-radius: 12px; margin: 32px 0 0 0; padding: 24px 0; text-align: center; font-size: 1.3rem; font-weight: 700; letter-spacing: 1px; box-shadow: 0 4px 24px 0 #5409DA22; }
        .flag { font-size: 1.2rem; color: #fff; background: #4E71FF; border-radius: 8px; padding: 10px 18px; margin-top: 12px; display: inline-block; }
        .source-btn { margin: 32px auto 0 auto; display: block; background: #fff; color: #5409DA; border: 2px solid #5409DA; border-radius: 8px; font-weight: 700; font-size: 1rem; padding: 10px 28px; cursor: pointer; transition: background 0.2s, color 0.2s, border 0.2s; }
        .source-btn:hover { background: #5409DA; color: #fff; }
        .modal-bg { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100vw; height: 100vh; background: rgba(30, 20, 60, 0.75); justify-content: center; align-items: center; }
        .modal-bg.active { display: flex; }
        .modal { background: #181c2f; color: #fff; border-radius: 14px; max-width: 90vw; width: 540px; max-height: 80vh; overflow: auto; box-shadow: 0 8px 32px 0 #5409DA55; padding: 32px 24px 24px 24px; position: relative; }
        .modal-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 18px; color: #8DD8FF; }
        .modal-close { position: absolute; top: 18px; right: 18px; background: none; border: none; color: #8DD8FF; font-size: 1.5rem; cursor: pointer; }
        pre.code-block { background: #23263a; color: #8DD8FF; border-radius: 8px; padding: 18px 12px; font-size: 0.98rem; font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace; overflow-x: auto; margin: 0; }
        .hint { background: #f8faff; border-left: 4px solid #5409DA; padding: 16px; margin: 20px 0; border-radius: 0 8px 8px 0; }
        .hint h4 { color: #5409DA; margin: 0 0 8px 0; }
        .hint p { margin: 0; color: #666; }
    </style>
</head>
<body>
    <nav class="main-nav">
        <div class="nav-inner">
            <div class="nav-logo">ğŸ” SQL Injection CTF</div>
            <div class="nav-actions">
                <a href="../index.html" class="back-btn" style="color: #fff;">â† ë©”ì¸ìœ¼ë¡œ</a>
            </div>
        </div>
    </nav>
    <div class="container">
        <header>
            <h1 style="color: #fff;">SQL Injection - ê²€ìƒ‰ ê¸°ëŠ¥ ìš°íšŒ</h1>
            <p style="color: #fff;">ì·¨ì•½í•œ ê²€ìƒ‰ ì¿¼ë¦¬ë¥¼ ìš°íšŒí•˜ì—¬ ìˆ¨ê²¨ì§„ ë°ì´í„°ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.</p>
        </header>        

        <div class="challenge-container">
            <div class="challenge-box">
                <div class="challenge-title">ê²Œì‹œê¸€ ê²€ìƒ‰</div>
                <form id="searchForm">
                    <label for="search" class="form-label">ê²€ìƒ‰ì–´</label>
                    <input type="text" id="search" class="form-input" placeholder="SQL Injection í˜ì´ë¡œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                    <button type="submit" class="action-btn">ê²€ìƒ‰ ì‹¤í–‰</button>
                </form>
                <div id="messageArea"></div>
                <div id="searchResult" class="result-area">
                    <h3>ê²€ìƒ‰ ê²°ê³¼</h3>
                    <div id="searchContent"></div>
                </div>
            </div>
        </div>

        <button class="source-btn" id="showSourceBtn">ì†ŒìŠ¤ì½”ë“œ ë³´ê¸°</button>
        
        <div class="modal-bg" id="modalBg">
            <div class="modal">
                <button class="modal-close" id="closeModalBtn">&times;</button>
                <div class="modal-title">ë¬¸ì œ ì†ŒìŠ¤ì½”ë“œ (Node.js/Express)</div>
                <pre class="code-block">// ì·¨ì•½í•œ ê²€ìƒ‰ API (SQLi)
function detectFlag(posts) {
    if (!Array.isArray(posts)) return false;
    for (let post of posts) {
        if (post && typeof post === 'object') {
            for (let key in post) {
                if (post[key] && typeof post[key] === 'string' && post[key] === 'Clear') {
                    return true;
                }
            }
        }
    }
    return false;
}

router.post('/search', async (req, res) => {
    const { search } = req.body;
    const keyword = search;
    // 1ë‹¨ê³„ í˜ì´ë¡œë“œ í•„í„°ë§
    if (!keyword || keyword.match(/(#|or|and)/i)) {
        return res.json({ success: false, message: 'ì…ë ¥ê°’ì´ í•„í„°ë§ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.' });
    }
    let conn;
    try {
        conn = await pool.getConnection();
        // ì·¨ì•½í•œ SQL ì¿¼ë¦¬ (ì‹¤ì œë¡œëŠ” ì ˆëŒ€ ì´ë ‡ê²Œ í•˜ë©´ ì•ˆë¨!)
        const query = `SELECT * FROM posts WHERE title = '${keyword}'`;
        let posts = await conn.query(query);
        if (!Array.isArray(posts)) {
            posts = [posts];
        }
        // í”Œë˜ê·¸ ê°ì§€
        const flagDetected = detectFlag(posts);
        if (flagDetected) {
            // 'Clear'ê°€ í¬í•¨ëœ postëŠ” ê²°ê³¼ì—ì„œ ì œì™¸
            const filteredPosts = posts.filter(post => {
                for (let key in post) {
                    if (post[key] && typeof post[key] === 'string' && post[key] === 'Clear') {
                        return false;
                    }
                }
                return true;
            });
            res.json({ 
                success: true, 
                posts: filteredPosts,
                flag: 'Clear',
                message: 'ğŸ‰ ê²€ìƒ‰ ìš°íšŒ ì„±ê³µ! SQL Injectionì´ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.'
            });
        } else {
            res.json({ success: true, posts });
        }
    } catch (err) {
        let errorMessage;
        if (err.errno === 1064 || err.code === 'ER_PARSE_ERROR' || err.code === 'ER_SYNTAX_ERROR') {
            errorMessage = 'SQL ë¬¸ë²• ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¿¼ë¦¬ êµ¬ë¬¸ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
        } else if (err.errno === 1146 || err.code === 'ER_NO_SUCH_TABLE') {
            errorMessage = 'í•´ë‹¹ í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        } else if (err.errno === 1054 || err.code === 'ER_BAD_FIELD_ERROR') {
            errorMessage = 'ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì»¬ëŸ¼ì…ë‹ˆë‹¤.';
        } else if (err.errno === 1045 || err.code === 'ER_ACCESS_DENIED_ERROR') {
            errorMessage = 'ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
        } else if (err.errno === 2006 || err.code === 'ER_CONNECTION_LOST') {
            errorMessage = 'ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.';
        } else if (err.errno === 1062 || err.code === 'ER_DUP_ENTRY') {
            errorMessage = 'ì¤‘ë³µëœ ë°ì´í„°ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.';
        } else if (err.errno === 1264 || err.code === 'ER_DATA_TOO_LONG') {
            errorMessage = 'ì…ë ¥ëœ ë°ì´í„°ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤.';
        } else if (err.errno === 1136 || err.code === 'ER_WRONG_VALUE_COUNT') {
            errorMessage = 'ì»¬ëŸ¼ ìˆ˜ì™€ ê°’ì˜ ìˆ˜ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
        } else if (err.errno === 1365 || err.code === 'ER_DIVISION_BY_ZERO') {
            errorMessage = '0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        } else if (err.errno === 1242 || err.code === 'ER_SUBQUERY_NO_1_ROW') {
            errorMessage = 'ì„œë¸Œì¿¼ë¦¬ê°€ 2ê°œ ì´ìƒì˜ í–‰ì„ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.';
        } else {
            errorMessage = 'ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
        }
        if (err.sqlMessage) {
            errorMessage += `\n(DB ì˜¤ë¥˜: ${err.sqlMessage})`;
        }
        res.json({ success: false, message: errorMessage });
    } finally {
        if (conn) conn.release();
    }
});</pre>
            </div>
        </div>

        <div id="flag-container" class="flag-container" style="display: none;">
            <h2>ğŸ‰ ì„±ê³µ!</h2>
            <div class="flag">
                <span id="flag-text"></span>
            </div>
        </div>
        
        <!-- ë¬¸ì œ í•´ê²° ìƒíƒœ í‘œì‹œ (í‘¸í„°) -->
        <div id="footer-status" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #5409DA; color: #fff; padding: 15px; text-align: center; font-weight: bold; z-index: 1000;">
            <i class="fas fa-check-circle"></i> ë¬¸ì œ í•´ê²° ì™„ë£Œ!
        </div>
    </div>

    <script>
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const search = document.getElementById('search').value;
            const resultArea = document.getElementById('searchResult');
            const resultContent = document.getElementById('searchContent');
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';
            
            try {
                const response = await fetch('/api/challenge2/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ search })
                });
                const data = await response.json();
                
                resultArea.style.display = 'block';
                
                if (data.message) {
                    messageArea.innerHTML = `<div style='color:#00bb77;font-weight:bold;margin-bottom:15px;'>${data.message}</div>`;
                } else {
                    messageArea.innerHTML = '';
                }
                
                if (data.flag) {
                    document.getElementById('flag-container').style.display = 'block';
                    document.getElementById('flag-text').textContent = 'ì¶•í•˜í•©ë‹ˆë‹¤! ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤!';
                    document.getElementById('footer-status').style.display = 'block';
                    resultContent.innerHTML = '';
                } else if (data.posts && data.posts.length > 0) {
                    resultContent.innerHTML = `
                        <div style='color:#5409DA;font-weight:bold;margin-bottom:15px;'>ê²€ìƒ‰ ê²°ê³¼ (${data.posts.length}ê°œ)</div>
                        ${data.posts.map(post => 
                            `<div style='background:#f8faff;padding:10px 0 10px 10px;border-radius:6px;margin-bottom:10px;'>
                                <b style='color:#5409DA;'>${post.title || 'ì œëª© ì—†ìŒ'}</b><br>
                                <span style='color:#333;'>${post.content || 'ë‚´ìš© ì—†ìŒ'}</span>
                                ${post.author ? `<br><small style='color:#666;'>ì‘ì„±ì: ${post.author}</small>` : ''}
                            </div>`
                        ).join('')}
                    `;
                } else {
                    resultContent.innerHTML = '';
                }
            } catch (error) {
                resultArea.style.display = 'block';
                messageArea.innerHTML = `<div style='color:#ff4444;font-weight:bold;'>âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
                resultContent.innerHTML = '';
            }
        });

        // ì†ŒìŠ¤ì½”ë“œ ëª¨ë‹¬
        const showSourceBtn = document.getElementById('showSourceBtn');
        const modalBg = document.getElementById('modalBg');
        const closeModalBtn = document.getElementById('closeModalBtn');
        showSourceBtn.onclick = () => { modalBg.classList.add('active'); };
        closeModalBtn.onclick = () => { modalBg.classList.remove('active'); };
        modalBg.onclick = (e) => { if (e.target === modalBg) modalBg.classList.remove('active'); };
    </script>
</body>
</html> 